#!/usr/bin/env bash
set -euo pipefail

# Docker sandbox script for running opencode safely
# Mounts project directory and copies opencode config with permissive permissions

IMAGE_NAME="opencode-jail"
DOCKERFILE="Dockerfile.jail"
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_DIR="$(pwd)"
CONFIG_DIR="${HOME}/.config/opencode"
TEMP_CONFIG_DIR=""

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Check if Docker is available
if ! command -v docker &> /dev/null; then
    echo -e "${RED}Error: docker is not installed or not in PATH${NC}" >&2
    exit 1
fi

# Check if Docker daemon is running
if ! docker info &> /dev/null; then
    echo -e "${RED}Error: Docker daemon is not running${NC}" >&2
    exit 1
fi

# Create temporary config directory with permissive permissions
TEMP_CONFIG_DIR=$(mktemp -d)
trap 'rm -rf "${TEMP_CONFIG_DIR}"' EXIT INT TERM

# Copy existing config if it exists
if [[ -d "${CONFIG_DIR}" ]]; then
    echo -e "${YELLOW}Copying opencode config...${NC}"
    cp -r "${CONFIG_DIR}"/* "${TEMP_CONFIG_DIR}/" 2>/dev/null || true
fi

# Create or update opencode.json with permissive permissions
CONFIG_FILE="${TEMP_CONFIG_DIR}/opencode.json"

# If config file exists, try to merge permissions; otherwise create new
if [[ -f "${CONFIG_FILE}" ]]; then
    # Use jq if available to merge, otherwise create new with permissions
    if command -v jq &> /dev/null; then
        jq '.permission = {"bash": {"*": "allow"}}' "${CONFIG_FILE}" > "${CONFIG_FILE}.tmp" && \
        mv "${CONFIG_FILE}.tmp" "${CONFIG_FILE}"
    else
        # Fallback: create new config with permissions (preserving other keys if possible)
        echo -e "${YELLOW}Note: jq not found, creating new config with permissive permissions${NC}"
        cat > "${CONFIG_FILE}" <<'EOF'
{
  "$schema": "https://opencode.ai/config.json",
  "permission": {
    "bash": {
      "*": "allow"
    }
  }
}
EOF
    fi
else
    # Create new config file with permissive permissions
    cat > "${CONFIG_FILE}" <<'EOF'
{
  "$schema": "https://opencode.ai/config.json",
  "permission": {
    "bash": {
      "*": "allow"
    }
  }
}
EOF
fi

echo -e "${GREEN}Using permissive permissions in sandbox${NC}"

# Check for Dockerfile.jail in current directory, copy default if missing
LOCAL_DOCKERFILE="${PROJECT_DIR}/${DOCKERFILE}"
DEFAULT_DOCKERFILE="${SCRIPT_DIR}/${DOCKERFILE}"

if [[ ! -f "${LOCAL_DOCKERFILE}" ]]; then
    echo -e "${YELLOW}No ${DOCKERFILE} found in current directory.${NC}"
    echo -e "${GREEN}Copying default ${DOCKERFILE} to ${PROJECT_DIR}${NC}"
    cp "${DEFAULT_DOCKERFILE}" "${LOCAL_DOCKERFILE}"
    echo -e "${YELLOW}Please update ${DOCKERFILE} to include any dependencies needed for your project.${NC}"
    echo ""
fi

# Build image using local Dockerfile
# Note: To force a rebuild after modifying Dockerfile, delete the image first:
#   docker rmi ${IMAGE_NAME}
if ! docker image inspect "${IMAGE_NAME}" &> /dev/null; then
    echo -e "${GREEN}Building Docker image: ${IMAGE_NAME}${NC}"
    docker build -f "${LOCAL_DOCKERFILE}" -t "${IMAGE_NAME}" "${PROJECT_DIR}" || {
        echo -e "${RED}Failed to build Docker image${NC}" >&2
        exit 1
    }
fi

# Collect environment variables to pass through
ENV_VARS=()
if [[ -n "${OPENROUTER_API_KEY:-}" ]]; then
    ENV_VARS+=(-e "OPENROUTER_API_KEY=${OPENROUTER_API_KEY}")
fi
if [[ -n "${OPENROUTER_MODEL:-}" ]]; then
    ENV_VARS+=(-e "OPENROUTER_MODEL=${OPENROUTER_MODEL}")
fi
if [[ -n "${JIRA_API_TOKEN:-}" ]]; then
    ENV_VARS+=(-e "JIRA_API_TOKEN=${JIRA_API_TOKEN}")
fi

# Determine command to run (default to opencode if no arguments)
if [[ $# -eq 0 ]]; then
    CMD=("opencode")
else
    CMD=("$@")
fi

# Run container with mounts
echo -e "${GREEN}Starting Docker sandbox...${NC}"
echo -e "${YELLOW}Project: ${PROJECT_DIR}${NC}"
echo -e "${YELLOW}Config: ${TEMP_CONFIG_DIR} (copied with permissive permissions)${NC}"
echo -e "${YELLOW}Command: ${CMD[*]}${NC}"
echo ""

docker run --rm -it \
    --network host \
    -v "${PROJECT_DIR}:/workspace" \
    -v "${TEMP_CONFIG_DIR}:/root/.config/opencode" \
    -w /workspace \
    "${ENV_VARS[@]}" \
    "${IMAGE_NAME}" \
    "${CMD[@]}"

