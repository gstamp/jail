#!/usr/bin/env bash
set -euo pipefail

# Docker sandbox script for running opencode safely
# Mounts project directory and opencode config with permissive permissions override

DOCKERFILE="Dockerfile.jail"
# Resolve symlinks to find the actual script directory
SCRIPT_PATH="${BASH_SOURCE[0]}"
while [[ -L "${SCRIPT_PATH}" ]]; do
    SCRIPT_DIR="$(cd "$(dirname "${SCRIPT_PATH}")" && pwd)"
    SCRIPT_PATH="$(readlink "${SCRIPT_PATH}")"
    # Handle relative symlinks
    [[ "${SCRIPT_PATH}" != /* ]] && SCRIPT_PATH="${SCRIPT_DIR}/${SCRIPT_PATH}"
done
SCRIPT_DIR="$(cd "$(dirname "${SCRIPT_PATH}")" && pwd)"
PROJECT_DIR="$(pwd)"
CONFIG_DIR="${HOME}/.config/opencode"
DATA_DIR="${HOME}/.local/share/opencode"
JAIL_PERMISSIONS="${SCRIPT_DIR}/jail-permissions.json"

# Generate project-specific image name based on project directory hash
PROJECT_HASH=$(echo -n "${PROJECT_DIR}" | md5sum | cut -c1-12)
IMAGE_NAME="opencode-jail-${PROJECT_HASH}"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Handle --help flag
if [[ "${1:-}" == "--help" ]] || [[ "${1:-}" == "-h" ]]; then
    echo "Usage: jail [OPTIONS] [COMMAND]"
    echo ""
    echo "Run opencode in a Docker sandbox with project-specific isolation"
    echo ""
    echo "Options:"
    echo "  --init          Initialize Dockerfile.jail in current directory"
    echo "  --cleanup       Remove all opencode-jail images"
    echo "  --help, -h      Show this help message"
    echo ""
    echo "Examples:"
    echo "  jail                    # Run opencode with project-specific image"
    echo "  jail --init             # Initialize Dockerfile for this project"
    echo "  jail --cleanup          # Remove all generated images"
    echo "  jail echo 'hello'       # Run custom command in sandbox"
    exit 0
fi

# Handle --init flag
if [[ "${1:-}" == "--init" ]]; then
    LOCAL_DOCKERFILE="${PROJECT_DIR}/${DOCKERFILE}"
    DEFAULT_DOCKERFILE="${SCRIPT_DIR}/${DOCKERFILE}"

    if [[ -f "${LOCAL_DOCKERFILE}" ]]; then
        echo -e "${YELLOW}${DOCKERFILE} already exists in this directory.${NC}"
        echo ""
        echo "To reset it to the default, remove it first:"
        echo "  rm ${DOCKERFILE}"
        echo "  jail --init"
        exit 0
    fi

    echo -e "${GREEN}Initializing jail for this project...${NC}"
    cp "${DEFAULT_DOCKERFILE}" "${LOCAL_DOCKERFILE}"
    echo ""
    echo -e "${GREEN}Created ${DOCKERFILE}${NC}"
    echo ""
    echo "Next steps:"
    echo "  1. Edit ${DOCKERFILE} to add your project's dependencies"
    echo "     For example, add package installations after the apt-get section:"
    echo ""
    echo "       # Node.js project"
    echo "       RUN apt-get update && apt-get install -y nodejs npm"
    echo ""
    echo "       # Python project"
    echo "       RUN apt-get update && apt-get install -y python3 python3-pip"
    echo ""
    echo "       # Go project"
    echo "       RUN apt-get update && apt-get install -y golang"
    echo ""
    echo "  2. Run 'jail' to build the image and start the sandbox"
    echo ""
    echo "  3. If you modify ${DOCKERFILE} later, rebuild with:"
    echo "       jail"
    echo "     (The image will be automatically rebuilt)"
    echo ""
    echo "  4. To clean up all opencode-jail images:"
    echo "       jail --cleanup"
    exit 0
fi

# Handle --cleanup flag
if [[ "${1:-}" == "--cleanup" ]]; then
    echo -e "${YELLOW}Searching for opencode-jail images...${NC}"

    # Find all opencode-jail images
    IMAGES=$(docker images --format "{{.Repository}}:{{.Tag}}" | grep "^opencode-jail-" || true)

    if [[ -z "${IMAGES}" ]]; then
        echo -e "${GREEN}No opencode-jail images found.${NC}"
        exit 0
    fi

    echo -e "${YELLOW}Found the following images:${NC}"
    echo "${IMAGES}"
    echo ""

    # Count images
    IMAGE_COUNT=$(echo "${IMAGES}" | wc -l)
    echo -e "${YELLOW}Total images to remove: ${IMAGE_COUNT}${NC}"
    echo ""

    # Ask for confirmation
    read -p "Do you want to remove all these images? (y/N): " -n 1 -r
    echo ""
    if [[ $REPLY =~ ^[Yy]$ ]]; then
        echo -e "${GREEN}Removing images...${NC}"
        # Remove each image
        echo "${IMAGES}" | while read -r image; do
            if [[ -n "${image}" ]]; then
                echo "  Removing ${image}..."
                docker rmi "${image}" 2>/dev/null || echo "    (already removed or in use)"
            fi
        done
        echo -e "${GREEN}Cleanup complete!${NC}"
    else
        echo -e "${YELLOW}Cleanup cancelled.${NC}"
    fi
    exit 0
fi

# Check if Docker is available
if ! command -v docker &> /dev/null; then
    echo -e "${RED}Error: docker is not installed or not in PATH${NC}" >&2
    exit 1
fi

# Check if Docker daemon is running
if ! docker info &> /dev/null; then
    echo -e "${RED}Error: Docker daemon is not running${NC}" >&2
    exit 1
fi

# Ensure config and data directories exist for session persistence
mkdir -p "${CONFIG_DIR}"
mkdir -p "${DATA_DIR}"

echo -e "${GREEN}Using permissive permissions in sandbox${NC}"
echo -e "${GREEN}Session history will persist in ${DATA_DIR}${NC}"
echo -e "${YELLOW}Project hash: ${PROJECT_HASH}${NC}"
echo -e "${YELLOW}Image name: ${IMAGE_NAME}${NC}"

# Check for Dockerfile.jail in current directory, copy default if missing
LOCAL_DOCKERFILE="${PROJECT_DIR}/${DOCKERFILE}"
DEFAULT_DOCKERFILE="${SCRIPT_DIR}/${DOCKERFILE}"

if [[ ! -f "${LOCAL_DOCKERFILE}" ]]; then
    echo -e "${YELLOW}No ${DOCKERFILE} found in current directory.${NC}"
    echo -e "${GREEN}Copying default ${DOCKERFILE} to ${PROJECT_DIR}${NC}"
    cp "${DEFAULT_DOCKERFILE}" "${LOCAL_DOCKERFILE}"
    echo -e "${YELLOW}Please update ${DOCKERFILE} to include any dependencies needed for your project.${NC}"
    echo ""
fi

# Build image using local Dockerfile if it doesn't exist or Dockerfile has changed
NEEDS_BUILD=false

if ! docker image inspect "${IMAGE_NAME}" &> /dev/null; then
    NEEDS_BUILD=true
else
    # Get image creation timestamp (seconds since epoch)
    IMAGE_CREATED=$(docker image inspect "${IMAGE_NAME}" --format '{{.Created}}')
    # Parse timestamp - try macOS format first, then Linux
    IMAGE_EPOCH=$(date -j -f "%Y-%m-%dT%H:%M:%S" "${IMAGE_CREATED:0:19}" +%s 2>/dev/null || \
                  date -d "${IMAGE_CREATED}" +%s 2>/dev/null || echo "0")
    IMAGE_EPOCH=${IMAGE_EPOCH:-0}
    # Ensure it's a valid number
    [[ "${IMAGE_EPOCH}" =~ ^[0-9]+$ ]] || IMAGE_EPOCH=0

    # Get Dockerfile modification timestamp (macOS uses -f, Linux uses -c)
    # Try Linux format first, then macOS
    DOCKERFILE_EPOCH=$(stat -c %Y "${LOCAL_DOCKERFILE}" 2>/dev/null || \
                       stat -f %m "${LOCAL_DOCKERFILE}" 2>/dev/null || echo "0")
    DOCKERFILE_EPOCH=${DOCKERFILE_EPOCH:-0}
    # Ensure it's a valid number
    [[ "${DOCKERFILE_EPOCH}" =~ ^[0-9]+$ ]] || DOCKERFILE_EPOCH=0

    if [[ "${DOCKERFILE_EPOCH}" -gt "${IMAGE_EPOCH}" ]]; then
        echo -e "${YELLOW}${DOCKERFILE:-Dockerfile.jail} has been modified since image was built. Rebuilding...${NC}"
        NEEDS_BUILD=true
    fi
fi

if [[ "${NEEDS_BUILD}" == "true" ]]; then
    echo -e "${GREEN}Building project-specific Docker image: ${IMAGE_NAME}${NC}"
    docker build -f "${LOCAL_DOCKERFILE}" -t "${IMAGE_NAME}" "${PROJECT_DIR}" || {
        echo -e "${RED}Failed to build Docker image${NC}" >&2
        exit 1
    }
fi

# Collect environment variables to pass through
ENV_VARS=()
if [[ -n "${OPENROUTER_API_KEY:-}" ]]; then
    ENV_VARS+=(-e "OPENROUTER_API_KEY=${OPENROUTER_API_KEY}")
fi
if [[ -n "${OPENROUTER_MODEL:-}" ]]; then
    ENV_VARS+=(-e "OPENROUTER_MODEL=${OPENROUTER_MODEL}")
fi
if [[ -n "${JIRA_API_TOKEN:-}" ]]; then
    ENV_VARS+=(-e "JIRA_API_TOKEN=${JIRA_API_TOKEN}")
fi

# Determine command to run (default to opencode if no arguments)
if [[ $# -eq 0 ]]; then
    CMD=("opencode")
else
    CMD=("$@")
fi

# Run container with mounts
echo -e "${GREEN}Starting Docker sandbox...${NC}"
echo -e "${YELLOW}Project: ${PROJECT_DIR}${NC}"
echo -e "${YELLOW}Config: ${CONFIG_DIR} (persistent)${NC}"
echo -e "${YELLOW}Command: ${CMD[*]}${NC}"
echo ""

docker run --rm -it \
    --network host \
    -v "${PROJECT_DIR}:/workspace" \
    -v "${CONFIG_DIR}:/root/.config/opencode" \
    -v "${DATA_DIR}:/root/.local/share/opencode" \
    -v "${HOME}/.gitconfig:/root/.gitconfig:ro" \
    -v "${JAIL_PERMISSIONS}:/tmp/jail-permissions.json:ro" \
    -e "OPENCODE_CONFIG=/tmp/jail-permissions.json" \
    -w /workspace \
    "${ENV_VARS[@]}" \
    "${IMAGE_NAME}" \
    "${CMD[@]}"

