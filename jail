#!/usr/bin/env bash
set -euo pipefail

# Docker sandbox script for running opencode safely
# Mounts project directory and copies opencode config with permissive permissions

IMAGE_NAME="opencode-jail"
DOCKERFILE="Dockerfile.jail"
# Resolve symlinks to find the actual script directory
SCRIPT_PATH="${BASH_SOURCE[0]}"
while [[ -L "${SCRIPT_PATH}" ]]; do
    SCRIPT_DIR="$(cd "$(dirname "${SCRIPT_PATH}")" && pwd)"
    SCRIPT_PATH="$(readlink "${SCRIPT_PATH}")"
    # Handle relative symlinks
    [[ "${SCRIPT_PATH}" != /* ]] && SCRIPT_PATH="${SCRIPT_DIR}/${SCRIPT_PATH}"
done
SCRIPT_DIR="$(cd "$(dirname "${SCRIPT_PATH}")" && pwd)"
PROJECT_DIR="$(pwd)"
CONFIG_DIR="${HOME}/.config/opencode"
TEMP_CONFIG_DIR=""

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Handle --init flag
if [[ "${1:-}" == "--init" ]]; then
    LOCAL_DOCKERFILE="${PROJECT_DIR}/${DOCKERFILE}"
    DEFAULT_DOCKERFILE="${SCRIPT_DIR}/${DOCKERFILE}"

    if [[ -f "${LOCAL_DOCKERFILE}" ]]; then
        echo -e "${YELLOW}${DOCKERFILE} already exists in this directory.${NC}"
        echo ""
        echo "To reset it to the default, remove it first:"
        echo "  rm ${DOCKERFILE}"
        echo "  jail --init"
        exit 0
    fi

    echo -e "${GREEN}Initializing jail for this project...${NC}"
    cp "${DEFAULT_DOCKERFILE}" "${LOCAL_DOCKERFILE}"
    echo ""
    echo -e "${GREEN}Created ${DOCKERFILE}${NC}"
    echo ""
    echo "Next steps:"
    echo "  1. Edit ${DOCKERFILE} to add your project's dependencies"
    echo "     For example, add package installations after the apt-get section:"
    echo ""
    echo "       # Node.js project"
    echo "       RUN apt-get update && apt-get install -y nodejs npm"
    echo ""
    echo "       # Python project"
    echo "       RUN apt-get update && apt-get install -y python3 python3-pip"
    echo ""
    echo "       # Go project"
    echo "       RUN apt-get update && apt-get install -y golang"
    echo ""
    echo "  2. Run 'jail' to build the image and start the sandbox"
    echo ""
    echo "  3. If you modify ${DOCKERFILE} later, rebuild with:"
    echo "       docker rmi ${IMAGE_NAME}"
    echo "       jail"
    exit 0
fi

# Check if Docker is available
if ! command -v docker &> /dev/null; then
    echo -e "${RED}Error: docker is not installed or not in PATH${NC}" >&2
    exit 1
fi

# Check if Docker daemon is running
if ! docker info &> /dev/null; then
    echo -e "${RED}Error: Docker daemon is not running${NC}" >&2
    exit 1
fi

# Create temporary config directory with permissive permissions
TEMP_CONFIG_DIR=$(mktemp -d)
trap 'rm -rf "${TEMP_CONFIG_DIR}"' EXIT INT TERM

# Copy existing config if it exists
if [[ -d "${CONFIG_DIR}" ]]; then
    echo -e "${YELLOW}Copying opencode config...${NC}"
    cp -r "${CONFIG_DIR}"/* "${TEMP_CONFIG_DIR}/" 2>/dev/null || true
fi

# Create or update opencode.json with permissive permissions
CONFIG_FILE="${TEMP_CONFIG_DIR}/opencode.json"

# If config file exists, try to merge permissions; otherwise create new
if [[ -f "${CONFIG_FILE}" ]]; then
    # Use jq if available to merge, otherwise create new with permissions
    if command -v jq &> /dev/null; then
        jq '.permission = {"bash": {"*": "allow"}}' "${CONFIG_FILE}" > "${CONFIG_FILE}.tmp" && \
        mv "${CONFIG_FILE}.tmp" "${CONFIG_FILE}"
    else
        # Fallback: create new config with permissions (preserving other keys if possible)
        echo -e "${YELLOW}Note: jq not found, creating new config with permissive permissions${NC}"
        cat > "${CONFIG_FILE}" <<'EOF'
{
  "$schema": "https://opencode.ai/config.json",
  "permission": {
    "bash": {
      "*": "allow"
    }
  }
}
EOF
    fi
else
    # Create new config file with permissive permissions
    cat > "${CONFIG_FILE}" <<'EOF'
{
  "$schema": "https://opencode.ai/config.json",
  "permission": {
    "bash": {
      "*": "allow"
    }
  }
}
EOF
fi

echo -e "${GREEN}Using permissive permissions in sandbox${NC}"

# Check for Dockerfile.jail in current directory, copy default if missing
LOCAL_DOCKERFILE="${PROJECT_DIR}/${DOCKERFILE}"
DEFAULT_DOCKERFILE="${SCRIPT_DIR}/${DOCKERFILE}"

if [[ ! -f "${LOCAL_DOCKERFILE}" ]]; then
    echo -e "${YELLOW}No ${DOCKERFILE} found in current directory.${NC}"
    echo -e "${GREEN}Copying default ${DOCKERFILE} to ${PROJECT_DIR}${NC}"
    cp "${DEFAULT_DOCKERFILE}" "${LOCAL_DOCKERFILE}"
    echo -e "${YELLOW}Please update ${DOCKERFILE} to include any dependencies needed for your project.${NC}"
    echo ""
fi

# Build image using local Dockerfile if it doesn't exist or Dockerfile has changed
NEEDS_BUILD=false

if ! docker image inspect "${IMAGE_NAME}" &> /dev/null; then
    NEEDS_BUILD=true
else
    # Get image creation timestamp (seconds since epoch)
    IMAGE_CREATED=$(docker image inspect "${IMAGE_NAME}" --format '{{.Created}}')
    # Parse timestamp - try macOS format first, then Linux
    IMAGE_EPOCH=$(date -j -f "%Y-%m-%dT%H:%M:%S" "${IMAGE_CREATED:0:19}" +%s 2>/dev/null || \
                  date -d "${IMAGE_CREATED}" +%s 2>/dev/null)

    # Get Dockerfile modification timestamp (macOS uses -f, Linux uses -c)
    DOCKERFILE_EPOCH=$(stat -f %m "${LOCAL_DOCKERFILE}" 2>/dev/null || \
                       stat -c %Y "${LOCAL_DOCKERFILE}" 2>/dev/null)

    if [[ "${DOCKERFILE_EPOCH}" -gt "${IMAGE_EPOCH}" ]]; then
        echo -e "${YELLOW}${DOCKERFILE} has been modified since image was built. Rebuilding...${NC}"
        NEEDS_BUILD=true
    fi
fi

if [[ "${NEEDS_BUILD}" == "true" ]]; then
    echo -e "${GREEN}Building Docker image: ${IMAGE_NAME}${NC}"
    docker build -f "${LOCAL_DOCKERFILE}" -t "${IMAGE_NAME}" "${PROJECT_DIR}" || {
        echo -e "${RED}Failed to build Docker image${NC}" >&2
        exit 1
    }
fi

# Collect environment variables to pass through
ENV_VARS=()
if [[ -n "${OPENROUTER_API_KEY:-}" ]]; then
    ENV_VARS+=(-e "OPENROUTER_API_KEY=${OPENROUTER_API_KEY}")
fi
if [[ -n "${OPENROUTER_MODEL:-}" ]]; then
    ENV_VARS+=(-e "OPENROUTER_MODEL=${OPENROUTER_MODEL}")
fi
if [[ -n "${JIRA_API_TOKEN:-}" ]]; then
    ENV_VARS+=(-e "JIRA_API_TOKEN=${JIRA_API_TOKEN}")
fi

# Determine command to run (default to opencode if no arguments)
if [[ $# -eq 0 ]]; then
    CMD=("opencode")
else
    CMD=("$@")
fi

# Run container with mounts
echo -e "${GREEN}Starting Docker sandbox...${NC}"
echo -e "${YELLOW}Project: ${PROJECT_DIR}${NC}"
echo -e "${YELLOW}Config: ${TEMP_CONFIG_DIR} (copied with permissive permissions)${NC}"
echo -e "${YELLOW}Command: ${CMD[*]}${NC}"
echo ""

docker run --rm -it \
    --network host \
    -v "${PROJECT_DIR}:/workspace" \
    -v "${TEMP_CONFIG_DIR}:/root/.config/opencode" \
    -w /workspace \
    "${ENV_VARS[@]}" \
    "${IMAGE_NAME}" \
    "${CMD[@]}"

